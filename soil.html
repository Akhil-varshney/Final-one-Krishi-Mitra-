<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="doc_title">‡¥ï‡µÉ‡¥∑‡¥ø ‡¥Æ‡¥ø‡¥§‡µç‡¥∞ ‚Äî ‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥® | Krishi Mitra - Smart Farming Solution</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kannada:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&family=Poppins:wght==400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#38784E',
                        'secondary-green': '#51A36D',
                        'accent-blue': '#2563EB',
                    },
                }
            },
            plugins: [],
        }
    </script>

    <style>
        
        /* Global */
body {
    background-color: #f3f8f3;
    color: #0b3b2e;
    font-family: 'Noto Sans Malayalam', Inter, system-ui;
}

/* Form Inputs */
input[type="number"], select, input[type="text"] {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #c7e5d2;
    border-radius: 0.5rem;
    font-size: 1rem;
    box-sizing: border-box;
}

/* Soil Bar Layout */
.bar-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.bar-label {
    width: 140px;
    font-weight: 600;
    font-size: .95rem;
}
.bar-wrap {
    flex: 1;
    background: #e6f2ea;
    border-radius: 12px;
    padding: 6px;
    position: relative;
    overflow: hidden;
}
.bar-fill {
    height: 28px;
    width: 0%;
    border-radius: 10px;
    transition: width .7s cubic-bezier(.2,.9,.2,1),
                background .4s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: white;
    font-weight: 700;
    font-size: .9rem;
}
.bar-value {
    width: 60px;
    font-size: .85rem;
    text-align: right;
}

/* Smooth result reveal */
#output {
    opacity: 0;
    transform: translateY(6px);
    transition: all .35s ease;
}
#output.show {
    opacity: 1;
    transform: translateY(0);
}

/* Mobile & Tablet Fixes */
@media (max-width: 768px) {
    .bar-label {
        width: 100px;
        font-size: .85rem;
    }
    .bar-value {
        width: 45px;
    }
    #analysisText, #recommendations, #fertCalc {
        font-size: .9rem;
    }
}

/* Small phones */
@media (max-width: 480px) {
    input[type="file"], button {
        width: 100%;
    }
    .bar-row {
        flex-direction: column;
        align-items: flex-start;
    }
    .bar-label,
    .bar-value {
        width: 100%;
        text-align: left;
    }
    header h1 {
        font-size: 1rem;
    }
}
    </style>
</head>
<body>
    <div class="max-w-4xl mx-auto">
        <header class="flex gap-3 items-center mb-4">
            <div>
                <h1 class="text-xl font-bold m-0 text-primary-green">‡¥ï‡µÉ‡¥∑‡¥ø ‡¥Æ‡¥ø‡¥§‡µç‡¥∞ ‚Äî ‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥®</h1>
                <div class="text-sm text-gray-500">Quick test ‚Ä¢ PDF report ‚Ä¢ Cloud history</div>
            </div>
        </header>

        <section class="bg-white rounded-xl p-4 shadow-lg mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                
                <div>
                    <label for="plannedCrop" class="block text-sm text-gray-500 mb-1">‡¥Ü‡¥∏‡µÇ‡¥§‡µç‡¥∞‡¥ø‡¥§ ‡¥µ‡¥ø‡¥≥ / Planned Crop</label>
                    <select id="plannedCrop" class="focus:ring-primary-green focus:border-primary-green">
                        <option value="">‡¥≤‡¥ï‡µç‡¥∑‡µç‡¥Ø ‡¥µ‡¥ø‡¥≥ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï / Select Target Crop</option>
                        <option>Wheat</option>
                        <option>Rice</option>
                        <option>Sugarcane</option>
                        <option>Maize</option>
                        <option>Cotton</option>
                        <option>Tomato</option>
                    </select>
                </div>
                
                <div>
                    <label for="soilType" class="block text-sm text-gray-500 mb-1">‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡¥∞‡¥Ç / Soil Type</label>
                    <select id="soilType" class="focus:ring-primary-green focus:border-primary-green">
                        <option value="">‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡¥∞‡¥Ç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï / Select soil type</option>
                        <option>Loamy</option>
                        <option>Sandy</option>
                        <option>Clay</option>
                        <option>Black</option>
                        <option>Red</option>
                    </select>
                </div>

                <input id="ph" type="hidden" value="">
                <input id="nitrogen" type="hidden" value="">
                <input id="phosphorus" type="hidden" value="">
                <input id="potassium" type="hidden" value="">
                <input id="moisture" type="hidden" value="">
                <input id="oc" type="hidden" value="">
                <input id="rainfall" type="hidden" value="">
                <input id="farmerName" type="hidden" value="Farmer-ID-from-File"> 
                
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                
                <input id="fileUpload" type="file" accept=".pdf,.txt,.doc,.docx" class="p-2 border border-green-300 rounded-lg text-sm flex-grow min-w-40"/>
                
                <button id="parseBtn" class="bg-white border border-primary-green text-primary-green hover:bg-green-50 text-sm px-3 py-2 rounded-lg transition duration-150 whitespace-nowrap font-semibold">
                    ‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç ‡¥´‡¥Ø‡µΩ ‡¥µ‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï / Parse Soil Report File
                </button>
                
                <button id="analyzeBtn" class="bg-primary-green text-white hover:bg-green-700 text-sm px-3 py-2 rounded-lg transition duration-150 font-semibold whitespace-nowrap">
                    ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï & ‡¥∏‡¥Ç‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï / Analyze & Save
                </button>
                
                <button id="historyBtn" class="bg-accent-blue text-white hover:bg-blue-700 text-sm px-3 py-2 rounded-lg transition duration-150 font-semibold whitespace-nowrap">
                    ‡¥ü‡µç‡¥∞‡µÜ‡µª‡¥°‡µÅ‡¥ï‡µæ ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï / View Trends
                </button>
                
                <button id="pdfBtn" class="bg-primary-green text-white hover:bg-green-700 text-sm px-3 py-2 rounded-lg transition duration-150 font-semibold whitespace-nowrap">
                    PDF ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï / Generate PDF
                </button>
            </div>

            <div id="message" class="mt-3 p-3 rounded-lg border border-green-300 bg-green-50 text-sm text-green-900" style="display:none"></div>
        </section>

        <section id="output" class="bg-white rounded-xl p-6 shadow-lg mb-4">
            <div class="flex justify-between items-center flex-wrap gap-3">
                <div>
                    <div id="overallTag" class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">Status</div>
                </div>
                <div class="text-right flex items-center gap-3">
                    <button id="readAloudBtn" class="bg-gray-100 text-gray-700 hover:bg-gray-200 text-xs px-3 py-2 rounded-lg transition duration-150 whitespace-nowrap font-semibold" onclick="readAnalysis()">
                        üîä ‡¥µ‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï / Read Aloud
                    </button>
                    <div class="text-sm text-gray-500" id="dateTime"></div>
                </div>
            </div>

            <hr class="my-4 border-green-100">

            <div class="space-y-3 mb-4">
                <div class="bar-row">
                    <div class="bar-label">pH</div>
                    <div class="bar-wrap" id="bar_ph_wrap"><div id="bar_ph" class="bar-fill">‚Äî</div></div>
                    <div class="bar-value" id="val_ph">‚Äî</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Nitrogen (N)</div>
                    <div class="bar-wrap" id="bar_n_wrap"><div id="bar_n" class="bar-fill">‚Äî</div></div>
                    <div class="bar-value" id="val_n">‚Äî</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Phosphorus (P)</div>
                    <div class="bar-wrap" id="bar_p_wrap"><div id="bar_p" class="bar-fill">‚Äî</div></div>
                    <div class="bar-value" id="val_p">‚Äî</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Potassium (K)</div>
                    <div class="bar-wrap" id="bar_k_wrap"><div id="bar_k" class="bar-fill">‚Äî</div></div>
                    <div class="bar-value" id="val_k">‚Äî</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Moisture</div>
                    <div class="bar-wrap" id="bar_moisture_wrap"><div id="bar_moisture" class="bar-fill">‚Äî</div></div>
                    <div class="bar-value" id="val_moisture">‚Äî</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Organic Carbon (OC)</div>
                    <div class="bar-wrap" id="bar_oc_wrap"><div id="bar_oc" class="bar-fill">‚Äî</div></div>
                    <div class="bar-value" id="val_oc">‚Äî</div>
                </div>
            </div>

            <div id="analysisText" class="text-gray-800 text-base leading-7 p-4 bg-gray-50 rounded-xl shadow-inner"></div>

            <h3 class="mt-6 text-lg font-bold text-accent-blue flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600"></i> Soil History & Trend
            </h3>
            <div id="historyTrends" class="text-gray-700 p-4 rounded-xl bg-blue-50 shadow-inner">Click "View Trends" to load history from the cloud.</div>

            <h3 class="mt-6 text-lg font-bold text-primary-green flex items-center gap-2">
                <i class="fa-solid fa-seedling text-green-600"></i> Recommendations (for <span id="cropTitle">Selected Crop</span>)
            </h3>
            <div id="recommendations" class="text-gray-700 p-4 rounded-xl bg-green-50 shadow-inner"></div>

            <h3 id="moistureForecast" class="mt-6 p-4 rounded-xl bg-cyan-50 shadow-inner"><h3 class="mt-0 text-lg font-bold text-cyan-700 flex items-center gap-2"><i class="fa-solid fa-cloud-rain text-cyan-600"></i> Moisture & Rain Forecast (7 Days)</h3><div id="moistureForecastContent"></div></h3>

            <h3 class="mt-6 p-4 rounded-xl bg-primary-green text-white font-bold flex items-center gap-2">
                <i class="fa-solid fa-flask text-white"></i> Fertilizer Calculator (approx per acre)
            </h3>
            <div id="fertCalc" class="text-gray-700 p-4 bg-gray-100 rounded-xl shadow-inner"></div>
        </section>

        <footer class="bg-white rounded-xl p-4 shadow-lg text-center text-sm text-gray-500">
            <div>Built for Krishi Mitra ‚Äî available features: file parse, PDF, cloud history.</div>
        </footer>
    </div>

    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, getDocs, query, orderBy, limit
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9Q1-_604mrZ4XeddMz2n0S5umTuLLuic", 
            authDomain: "login-6e27a.firebaseapp.com",
            projectId: "login-6e27a",
            storageBucket: "login-6e27a.appspot.com",
            messagingSenderId: "728070142896",
            appId: "1:728070142896:web:ccfdd02a1bb5abff1af475",
            measurementId: "G-L2CVRRW7LL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let lastAnalysisResult = null;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('message').textContent = `Logged in as:(UID: ${user.uid.substring(0, 8)}...).`;
                document.getElementById('message').className = 'mt-3 p-3 rounded-lg border border-green-300 bg-green-50 text-sm text-green-900';
                document.getElementById('message').style.display = 'block';
            } else {
                alert("You are not logged in. Redirecting to login page.");
                
                document.getElementById('message').textContent = `Not logged in. Data saving is disabled.`;
                document.getElementById('message').className = 'mt-3 p-3 rounded-lg border border-red-300 bg-red-50 text-sm text-red-900';
                document.getElementById('message').style.display = 'block';
            }
        });

        async function saveToCloud(values, analysisResult) {
            if (!currentUserId) {
                alert("Error: Not logged in. Cannot save data to the cloud.");
                return;
            }
            try {
                
                await addDoc(collection(db, "SoilAnalysis", currentUserId, "Entries"), {
                    ...values,
                    ...analysisResult,
                    timestamp: new Date().toISOString()
                });
                showMessage("Analysis saved to Firebase Cloud successfully! ‚úî");
            } catch (error) {
                console.error("Error saving to cloud: ", error);
                showMessage("Failed to save data to Firebase Cloud.", true);
            }
        }

        async function loadHistory(fieldId) {
            if (!currentUserId) {
                historyTrendsEl.innerHTML = "You must be logged in to view cloud history.";
                return [];
            }
            try {
                
                const q = query(
                    collection(db, "SoilAnalysis", currentUserId, "Entries"),
                    orderBy("timestamp", "desc"),
                    limit(10) 
                );
                const snapshot = await getDocs(q);
                const history = [];
                let html = '';
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    history.push(d);
                    html += `<div class="p-3 bg-white border rounded-lg shadow-sm mb-2">
                        <div class="font-semibold text-green-700">${new Date(d.timestamp).toLocaleString()}</div>
                        <div class="text-sm text-gray-600">pH: ${d.ph ?? '‚Äî'}, N: ${d.n ?? '‚Äî'} kg/ha, Crop: ${d.plannedCrop || '‚Äî'}</div>
                    </div>`;
                });
                
                historyTrendsEl.innerHTML = html || "No cloud history found for this farmer.";
                showMessage(`Loaded ${history.length} records from Firebase Cloud.`, false);
                
                
                if (history.length >= 2) {
                    const latest = history[0];
                    const previous = history[1];
                    let trends = [];
                    const lang = getCurrentLanguage();
                    const trendStrings = languageAnalysisStrings[lang].trends;

                    ['ph', 'n', 'p', 'k', 'oc'].forEach(key => {
                        const v1 = parseFloat(latest[key]);
                        const v2 = parseFloat(previous[key]);
                        if (!isNaN(v1) && !isNaN(v2)) {
                            const diff = v1 - v2;
                            const param = key.toUpperCase();
                            if (Math.abs(diff) > 0.1) {
                                const changeKey = diff > 0 ? 'increased' : 'decreased';
                                trends.push(`‚Ä¢ ${param} ${trendStrings[changeKey]} ${v2.toFixed(2)} ${trendStrings.to} ${v1.toFixed(2)}.`);
                            } else {
                                trends.push(`‚Ä¢ ${param} ${trendStrings.stable}.`);
                            }
                        }
                    });
                    
                    historyTrendsEl.innerHTML = `<h4 class="font-bold text-lg mb-2">${trendStrings.heading}</h4>
                        <ul class="list-disc list-inside space-y-0.5">${trends.map(t => `<li>${t}</li>`).join('')}</ul>
                        <h4 class="font-bold text-lg mt-4 mb-2">${trendStrings.recent_reports}:</h4>` + historyTrendsEl.innerHTML;
                }

                return history;

            } catch (error) {
                console.error("Error loading history: ", error);
                historyTrendsEl.innerHTML = "Error loading history from cloud.";
                return [];
            }
        }

        
        const phEl = document.getElementById('ph');
        const nEl = document.getElementById('nitrogen');
        const pEl = document.getElementById('phosphorus');
        const kEl = document.getElementById('potassium');
        const mEl = document.getElementById('moisture');
        const ocEl = document.getElementById('oc');
        const soilTypeEl = document.getElementById('soilType');
        const farmerNameEl = document.getElementById('farmerName');
        const plannedCropEl = document.getElementById('plannedCrop');
        const rainfallEl = document.getElementById('rainfall');
        
        const message = document.getElementById('message');
        const output = document.getElementById('output');
        const analysisText = document.getElementById('analysisText');
        const recommendations = document.getElementById('recommendations');
        const fertCalc = document.getElementById('fertCalc');
        const overallTag = document.getElementById('overallTag');
        const dateTime = document.getElementById('dateTime');
        
        const moistureForecastSection = document.getElementById('moistureForecast');
        moistureForecastSection.innerHTML = '<h3 class="mt-0 text-lg font-bold text-cyan-700 flex items-center gap-2"><i class="fa-solid fa-cloud-rain text-cyan-600"></i> Moisture & Rain Forecast (7 Days)</h3><div id="moistureForecastContent"></div>';
        const moistureForecastContentEl = document.getElementById('moistureForecastContent');

        const historyTrendsEl = document.getElementById('historyTrends');
        const cropTitleEl = document.getElementById('cropTitle');


        const cropTargets = {
            'Wheat': { ph: [6.0, 7.5], n_target: 150, p_target: 35, k_target: 180, n_low: 110, p_low: 25, k_low: 120 },
            'Rice': { ph: [5.5, 6.5], n_target: 120, p_target: 25, k_target: 100, n_low: 80, p_low: 15, k_low: 70 },
            'Sugarcane': { ph: [6.5, 7.5], n_target: 250, p_target: 50, k_target: 150, n_low: 200, p_low: 40, k_low: 100 },
            'Maize': { ph: [6.0, 7.5], n_target: 160, p_target: 40, k_target: 100, n_low: 120, p_low: 30, k_low: 70 },
            'Cotton': { ph: [6.0, 7.5], n_target: 120, p_target: 30, k_target: 100, n_low: 90, p_low: 20, k_low: 70 },
            'Tomato': { ph: [6.0, 7.0], n_target: 180, p_target: 50, k_target: 220, n_low: 140, p_low: 40, k_low: 180 },
        };

        
        const languageAnalysisStrings = {
            'en': {
                status: { normal: 'Optimal Health', problem: 'Problem', missing: 'Missing Data' },
                notes: {
                    ph_missing: 'pH not provided', ph_invalid: 'pH value is invalid.', ph_acidic: (v, target) => `Too acidic (pH ${v} < ${target}). Low Zinc and Phosphorus availability.`,
                    ph_alkaline: (v, target) => `Alkaline (pH ${v} > ${target}). Micronutrients may be locked.`, ph_optimal: (v, crop) => `pH ${v} is OPTIMAL for ${crop || 'most crops'}.`,
                    npk_missing: (label) => `${label} not provided`, npk_invalid: (label) => `${label} value is invalid.`,
                    npk_low: (label, v, low) => `${label} LOW. Current: ${v} kg/ha (Target Low: ${low}).`, npk_medium: (label, v) => `${label} medium. Current: ${v} kg/ha.`,
                    npk_adequate: (label) => `${label} adequate.`,
                    moisture_invalid: 'Moisture value is invalid.', moisture_critical: 'Soil moisture critically low ‚Äî urgent irrigation needed.',
                    moisture_low: 'Soil moisture low ‚Äî consider irrigation or mulching', moisture_high: 'Soil moisture high ‚Äî check drainage', moisture_ok: 'Soil moisture OK',
                    oc_invalid: 'Organic Carbon value is invalid.', oc_critical: 'Organic carbon critically low ‚Äî add compost/FYM',
                    oc_low: 'Organic carbon low ‚Äî requires moderate addition of organic matter', oc_ok: 'Organic carbon acceptable',
                },
                recommendations: {
                    lime: 'Apply lime (calcium carbonate) as per soil test', gypsum: 'Use organic matter, gypsum for sodic soils',
                    fert_low: (fert) => `Apply ${fert} to bridge the gap.`, fert_medium: (crop) => `Top up with balanced fertilizer for optimal yield of ${crop}.`,
                    irrigate_now: 'Initiate irrigation immediately.', irrigate_mulch: 'Irrigate / mulch',
                    oc_fym: 'Add farmyard manure or compost (1-2 tons/acre)', oc_regular: 'Add organic matter regularly.',
                    suggested_crops: 'Suggested Crops:', immediate_actions: 'Immediate Actions:', no_actions: 'No immediate critical actions required based on current parameters.',
                    fertilizer_est: 'Estimated fertilizer need to reach LOW/MEDIUM threshold for the selected crop:',
                },
                fertilizers: { urea: 'Urea (46% N)', dap: 'DAP (18% N, 46% P2O5)', mop: 'MOP (60% K2O)' },
                trends: {
                    heading: 'Trend Analysis (Last 2 Reports)', increased: 'has **increased** from', decreased: 'has **decreased** from', to: 'to', stable: 'is stable', recent_reports: 'Recent Reports:',
                },
                forecast: {
                    missing: 'Forecast data missing. Please provide current Moisture (%) and 7-Day Rain Forecast (from file).',
                    table_day: 'Day', table_rain: 'Rain (mm)', table_moisture: 'Est. Moisture (%)', table_action: 'Action',
                    action_now: 'IRRIGATE NOW', action_monitor: 'Monitor Closely', action_ok: 'OK',
                    note: 'Note: This is an estimation. Actual results depend on temperature, wind, and crop.',
                }
            },
            'ml': {
                status: { normal: '‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥Ü‡¥∞‡µã‡¥ó‡µç‡¥Ø‡¥Ç', problem: '‡¥™‡µç‡¥∞‡¥∂‡µç‚Äå‡¥®‡¥Æ‡µÅ‡¥£‡µç‡¥ü‡µç', missing: '‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥≤‡µç‡¥≤' },
                notes: {
                    ph_missing: 'pH ‡¥®‡µΩ‡¥ï‡¥ø‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡¥ø‡¥≤‡µç‡¥≤', ph_invalid: 'pH ‡¥Æ‡µÇ‡¥≤‡µç‡¥Ø‡¥Ç ‡¥Ö‡¥∏‡¥æ‡¥ß‡µÅ‡¥µ‡¥æ‡¥£‡µç.', ph_acidic: (v, target) => `‡¥Ö‡¥Æ‡¥ø‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥Ö‡¥Æ‡µç‡¥≤‡¥§ (pH ${v} < ${target}). ‡¥∏‡¥ø‡¥ô‡µç‡¥ï‡µç, ‡¥´‡µã‡¥∏‡µç‡¥´‡¥±‡¥∏‡µç ‡¥≤‡¥≠‡µç‡¥Ø‡¥§ ‡¥ï‡µÅ‡¥±‡¥µ‡¥æ‡¥£‡µç.`,
                    ph_alkaline: (v, target) => `‡¥ï‡µç‡¥∑‡¥æ‡¥∞ ‡¥∏‡µç‡¥µ‡¥≠‡¥æ‡¥µ‡¥Ç (pH ${v} > ${target}). ‡¥∏‡µÇ‡¥ï‡µç‡¥∑‡µç‡¥Æ ‡¥™‡µã‡¥∑‡¥ï‡¥ô‡µç‡¥ô‡µæ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡¥æ‡¥Ç.`, ph_optimal: (v, crop) => `pH ${v} ${crop || '‡¥Æ‡¥ø‡¥ï‡µç‡¥ï ‡¥µ‡¥ø‡¥≥‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç'} ‡¥Ö‡¥®‡µÅ‡¥Ø‡µã‡¥ú‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç.`,
                    npk_missing: (label) => `${label} ‡¥®‡µΩ‡¥ï‡¥ø‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡¥ø‡¥≤‡µç‡¥≤`, npk_invalid: (label) => `${label} ‡¥Æ‡µÇ‡¥≤‡µç‡¥Ø‡¥Ç ‡¥Ö‡¥∏‡¥æ‡¥ß‡µÅ‡¥µ‡¥æ‡¥£‡µç.`,
                    npk_low: (label, v, low) => `${label} ‡¥ï‡µÅ‡¥±‡¥µ‡¥æ‡¥£‡µç. ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥Ö‡¥≥‡¥µ‡µç: ${v} kg/ha (‡¥ï‡µÅ‡¥±‡¥û‡µç‡¥û ‡¥≤‡¥ï‡µç‡¥∑‡µç‡¥Ø‡¥Ç: ${low}).`, npk_medium: (label, v) => `${label} ‡¥Æ‡¥ø‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥Ö‡¥≥‡¥µ‡¥ø‡¥≤‡¥æ‡¥£‡µç. ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥Ö‡¥≥‡¥µ‡µç: ${v} kg/ha.`,
                    npk_adequate: (label) => `${label} ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡¥®‡µÅ‡¥£‡µç‡¥ü‡µç.`,
                    moisture_invalid: '‡¥à‡µº‡¥™‡µç‡¥™‡¥§‡µç‡¥§‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥Ö‡¥≥‡¥µ‡µç ‡¥Ö‡¥∏‡¥æ‡¥ß‡µÅ‡¥µ‡¥æ‡¥£‡µç.', moisture_critical: '‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥≤‡µÜ ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‡¥§‡µÄ‡¥∞‡µÜ ‡¥ï‡µÅ‡¥±‡¥µ‡¥æ‡¥£‡µç ‚Äî ‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥ø‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥®‡¥®‡¥Ø‡µç‡¥ï‡µç‡¥ï‡¥£‡¥Ç.',
                    moisture_low: '‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥≤‡µÜ ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‡¥ï‡µÅ‡¥±‡¥µ‡¥æ‡¥£‡µç ‚Äî ‡¥®‡¥®‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µÜ‡¥ï‡µç‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µã ‡¥™‡µÅ‡¥§‡¥Ø‡¥ø‡¥ü‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µÜ‡¥ï‡µç‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µã ‡¥Ü‡¥≤‡µã‡¥ö‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', moisture_high: '‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥≤‡µÜ ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡¥≤‡¥æ‡¥£‡µç ‚Äî ‡¥®‡µÄ‡µº‡¥µ‡¥æ‡µº‡¥ö‡µç‡¥ö ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', moisture_ok: '‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥≤‡µÜ ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‡¥§‡µÉ‡¥™‡µç‡¥§‡¥ø‡¥ï‡¥∞‡¥Ç.',
                    oc_invalid: '‡¥ú‡µà‡¥µ ‡¥ï‡¥æ‡µº‡¥¨‡µ∫ ‡¥Æ‡µÇ‡¥≤‡µç‡¥Ø‡¥Ç ‡¥Ö‡¥∏‡¥æ‡¥ß‡µÅ‡¥µ‡¥æ‡¥£‡µç.', oc_critical: '‡¥ú‡µà‡¥µ ‡¥ï‡¥æ‡µº‡¥¨‡µ∫ ‡¥§‡µÄ‡¥∞‡µÜ ‡¥ï‡µÅ‡¥±‡¥µ‡¥æ‡¥£‡µç ‚Äî ‡¥ï‡¥Æ‡µç‡¥™‡µã‡¥∏‡µç‡¥±‡µç‡¥±‡µç/‡¥µ‡¥≥‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï.',
                    oc_low: '‡¥ú‡µà‡¥µ ‡¥ï‡¥æ‡µº‡¥¨‡µ∫ ‡¥ï‡µÅ‡¥±‡¥µ‡¥æ‡¥£‡µç ‚Äî ‡¥Æ‡¥ø‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥Ö‡¥≥‡¥µ‡¥ø‡µΩ ‡¥ú‡µà‡¥µ‡¥µ‡¥≥‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', oc_ok: '‡¥ú‡µà‡¥µ ‡¥ï‡¥æ‡µº‡¥¨‡µ∫ ‡¥§‡µÉ‡¥™‡µç‡¥§‡¥ø‡¥ï‡¥∞‡¥Ç.',
                },
                recommendations: {
                    lime: '‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥® ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥ï‡µÅ‡¥Æ‡µç‡¥Æ‡¥æ‡¥Ø‡¥Ç (‡¥ï‡¥æ‡¥§‡µç‡¥∏‡µç‡¥Ø‡¥Ç ‡¥ï‡¥æ‡µº‡¥¨‡¥£‡µá‡¥±‡µç‡¥±‡µç) ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', gypsum: '‡¥ú‡µà‡¥µ‡¥µ‡¥∏‡µç‡¥§‡µÅ‡¥ï‡µç‡¥ï‡¥≥‡µÅ‡¥Ç ‡¥∏‡µã‡¥°‡¥ø‡¥ï‡µç ‡¥Æ‡¥£‡µç‡¥£‡¥ø‡µΩ ‡¥ú‡¥ø‡¥™‡µç‡¥∏‡¥µ‡µÅ‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.',
                    fert_low: (fert) => `‡¥ï‡µÅ‡¥±‡¥µ‡µç ‡¥®‡¥ø‡¥ï‡¥§‡µç‡¥§‡¥æ‡µª ${fert} ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï.`, fert_medium: (crop) => `${crop} ‡¥µ‡¥ø‡¥≥‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥µ‡¥ø‡¥≥‡¥µ‡¥ø‡¥®‡¥æ‡¥Ø‡¥ø ‡¥∏‡¥®‡µç‡¥§‡µÅ‡¥≤‡¥ø‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥µ‡¥≥‡¥Ç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï.`,
                    irrigate_now: '‡¥â‡¥ü‡µª ‡¥®‡¥®‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', irrigate_mulch: '‡¥®‡¥®‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥ï / ‡¥™‡µÅ‡¥§‡¥Ø‡¥ø‡¥ü‡µÅ‡¥ï.',
                    oc_fym: '‡¥ï‡¥æ‡¥≤‡¥ø‡¥µ‡¥≥‡¥Ç ‡¥Ö‡¥•‡¥µ‡¥æ ‡¥ï‡¥Æ‡µç‡¥™‡µã‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï (1-2 ‡¥ü‡µ∫/‡¥è‡¥ï‡µç‡¥ï‡µº).', oc_regular: '‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥ú‡µà‡¥µ‡¥µ‡¥≥‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï.',
                    suggested_crops: '‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ø‡¥ö‡µç‡¥ö ‡¥µ‡¥ø‡¥≥‡¥ï‡µæ:', immediate_actions: '‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥ø‡¥∞ ‡¥®‡¥ü‡¥™‡¥ü‡¥ø‡¥ï‡µæ:', no_actions: '‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥Ö‡¥≥‡¥µ‡µÅ‡¥ï‡µæ ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥ø‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥®‡¥ü‡¥™‡¥ü‡¥ø‡¥ï‡µæ ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥ø‡¥≤‡µç‡¥≤.',
                    fertilizer_est: '‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥§‡µç‡¥§ ‡¥µ‡¥ø‡¥≥‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥Ø ‡¥ï‡µÅ‡¥±‡¥û‡µç‡¥û/‡¥á‡¥ü‡¥§‡µç‡¥§‡¥∞‡¥Ç ‡¥™‡¥∞‡¥ø‡¥ß‡¥ø‡¥Ø‡¥ø‡µΩ ‡¥é‡¥§‡µç‡¥§‡¥æ‡µª ‡¥µ‡µá‡¥£‡µç‡¥ü ‡¥µ‡¥≥‡¥§‡µç‡¥§‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥è‡¥ï‡¥¶‡µá‡¥∂ ‡¥Ö‡¥≥‡¥µ‡µç:',
                },
                fertilizers: { urea: '‡¥Ø‡µÇ‡¥±‡¥ø‡¥Ø (46% N)', dap: '‡¥°‡¥ø‡¥é‡¥™‡¥ø (18% N, 46% P2O5)', mop: '‡¥é‡¥Ç‡¥í‡¥™‡¥ø (60% K2O)' },
                trends: {
                    heading: '‡¥ü‡µç‡¥∞‡µÜ‡µª‡¥°‡µç ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç (‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥§‡µç‡¥§‡µÜ 2 ‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ)', increased: '‡¥µ‡µº‡¥¶‡µç‡¥ß‡¥ø‡¥ö‡µç‡¥ö‡µÅ', decreased: '‡¥ï‡µÅ‡¥±‡¥û‡µç‡¥û‡µÅ', to: '‡¥Æ‡µÅ‡¥§‡µΩ', stable: '‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥Æ‡¥æ‡¥£‡µç', recent_reports: '‡¥∏‡¥Æ‡µÄ‡¥™‡¥ï‡¥æ‡¥≤ ‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ:',
                },
                forecast: {
                    missing: '‡¥™‡µç‡¥∞‡¥µ‡¥ö‡¥® ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥≤‡µç‡¥≤. ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥à‡µº‡¥™‡µç‡¥™‡¥µ‡µÅ‡¥Ç (%) 7 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡µÜ ‡¥Æ‡¥¥‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µç‡¥∞‡¥µ‡¥ö‡¥®‡¥µ‡µÅ‡¥Ç (‡¥´‡¥Ø‡¥≤‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç) ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï.',
                    table_day: '‡¥¶‡¥ø‡¥µ‡¥∏‡¥Ç', table_rain: '‡¥Æ‡¥¥ (mm)', table_moisture: '‡¥è‡¥ï‡¥¶‡µá‡¥∂ ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç (%)', table_action: '‡¥®‡¥ü‡¥™‡¥ü‡¥ø',
                    action_now: '‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥®‡¥®‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥ï', action_monitor: '‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï', action_ok: '‡¥§‡µÉ‡¥™‡µç‡¥§‡¥ø‡¥ï‡¥∞‡¥Ç',
                    note: '‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï: ‡¥á‡¥§‡µç ‡¥í‡¥∞‡µÅ ‡¥è‡¥ï‡¥¶‡µá‡¥∂ ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥£‡µç. ‡¥Ø‡¥•‡¥æ‡µº‡¥§‡µç‡¥• ‡¥´‡¥≤‡¥ô‡µç‡¥ô‡µæ ‡¥§‡¥æ‡¥™‡¥®‡¥ø‡¥≤, ‡¥ï‡¥æ‡¥±‡µç‡¥±‡µç, ‡¥µ‡¥ø‡¥≥ ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ‡¥Ø‡µÜ ‡¥Ü‡¥∂‡µç‡¥∞‡¥Ø‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ.',
                }
            }
        };

        
        function getCurrentLanguage(){
            return 'ml'; 
        }

        function nowStr(){
            return new Date().toLocaleString();
        }

        function showMessage(txt, isError=false){
            message.style.display='block';
            message.innerHTML = txt;
            if(isError){
                message.className = 'mt-3 p-3 rounded-lg border border-red-300 bg-red-50 text-sm text-red-900';
            } else {
                message.className = 'mt-3 p-3 rounded-lg border border-green-300 bg-green-50 text-sm text-green-900';
            }
        }

        function hideMessage(){ message.style.display='none'; }

        
        function initializeOutput() {
            overallTag.textContent = 'Awaiting Input';
            overallTag.className = 'inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold';
            cropTitleEl.textContent = 'No Crop Selected';
            
            analysisText.innerHTML = '<p class="text-center italic text-gray-500">‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥® ‡¥´‡¥≤‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡¥æ‡¥£‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µç ‡¥í‡¥∞‡µÅ ‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç ‡¥´‡¥Ø‡µΩ ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï‡¥Ø‡µÅ‡¥Ç ‡¥µ‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï‡¥Ø‡µÅ‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.</p>'; 
            recommendations.innerHTML = '‚Äî';
            fertCalc.innerHTML = '‚Äî';
            historyTrendsEl.innerHTML = 'Click "View Trends" to load history from the cloud.';
            moistureForecastContentEl.innerHTML = '‚Äî';
            dateTime.textContent = nowStr();
            updateAllBars({
                ph: '',
                n: '',
                p: '',
                k: '',
                moisture: '',
                oc: '',
                plannedCrop: null
            });
            output.classList.remove('show');
        }


        
        function readAnalysis() {
            if (!window.speechSynthesis) {
                showMessage('Text-to-Speech not supported in this browser.', true);
                return;
            }

            if (!lastAnalysisResult) {
                showMessage('No analysis results to read. Please run an analysis first.', true);
                return;
            }

            window.speechSynthesis.cancel(); 

            const lang = lastAnalysisResult.res.lang === 'ml' ? 'ml-IN' : 'en-US'; 
            const analysisTextContent = document.getElementById('analysisText').textContent;
            const recommendationsContent = document.getElementById('recommendations').textContent;

            
            const textToSpeak = `Analysis Summary. ${analysisTextContent}. Recommendations. ${recommendationsContent}`;

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = lang;
            
            
            utterance.rate = 0.9; 
            utterance.pitch = 1.0;

            
            const voices = window.speechSynthesis.getVoices();
            const voice = voices.find(v => v.lang.includes(lang));
            if (voice) {
                utterance.voice = voice;
            }


            window.speechSynthesis.speak(utterance);
            showMessage(`Reading aloud in ${lang} now...`);
            
            utterance.onend = () => {
                hideMessage();
            };
            utterance.onerror = (e) => {
                showMessage(`Error reading aloud: ${e.error}. Try running on a local server (localhost) or use a modern browser.`, true);
            };
        }
        window.readAnalysis = readAnalysis; 


        function predictMoisture(currentM, soilType, rainForecast, days = 7) {
            
            currentM = +currentM;
            const evapRateBase = { 'Sandy': 0.8, 'Loamy': 0.6, 'Clay': 0.4 }[soilType] || 0.6; 
            let results = [];
            let moisture = currentM;
            const lang = getCurrentLanguage();
            const forecastStrings = languageAnalysisStrings[lang].forecast;

            if(isNaN(currentM) || !rainForecast || rainForecast.length < days){
                return { status: 'Missing Data', results: [] };
            }

            for(let d=0; d<days; d++){
                const tempFactor = 1.0; 
                const drop = (evapRateBase * tempFactor) + (10 / (moisture + 1)); 
                
                moisture = moisture - drop + (rainForecast[d] / 8); 
                moisture = Math.max(0, Math.min(100, moisture));

                let action = '';
                if(moisture < 12) action = forecastStrings.action_now;
                else if(moisture < 18) action = forecastStrings.action_monitor;
                else action = forecastStrings.action_ok;
                
                results.push({ day: d+1, rain: rainForecast[d], moisture: moisture.toFixed(1), action });
            }
            return { status: 'Forecast Complete', results };
        }
        
        function analyze(values){
            const {ph, n, p, k, moisture, oc, soilType, farmerName, plannedCrop} = values;
            const target = plannedCrop ? cropTargets[plannedCrop] : null;
            
            let lang = getCurrentLanguage();
            const strings = languageAnalysisStrings[lang];
            
            let status = strings.status.normal;
            let notes = [];
            let rec = [];

            
            if(ph === null || ph === undefined || ph === '') notes.push({ key: 'ph_missing' });
            else {
                const phv = parseFloat(ph);
                if(isNaN(phv)) { notes.push({ key: 'ph_invalid' }); status=strings.status.problem; }
                else {
                    const phRange = target ? target.ph : [6.0, 7.5]; 

                    if(phv < phRange[0]) { 
                        notes.push({ key: 'ph_acidic', v: phv, target: phRange[0] }); 
                        rec.push({ key: 'lime' }); 
                        status=strings.status.problem; 
                    }
                    else if(phv > phRange[1]) { 
                        notes.push({ key: 'ph_alkaline', v: phv, target: phRange[1] }); 
                        rec.push({ key: 'gypsum' }); 
                        status=strings.status.problem; 
                    }
                    else { notes.push({ key: 'ph_optimal', v: phv, crop: plannedCrop }); }
                }
            }

            
            const npkLabelsML = { 'n': '‡¥®‡µà‡¥ü‡µç‡¥∞‡¥ú‡µª (N)', 'p': '‡¥´‡µã‡¥∏‡µç‡¥´‡¥±‡¥∏‡µç (P)', 'k': '‡¥™‡µä‡¥ü‡µç‡¥ü‡¥æ‡¥∏‡µç‡¥Ø‡¥Ç (K)' };

            const npkCheck = [
                { key: 'n', val: n, label: strings.notes.label_nitrogen || 'Nitrogen', unit: 'kg/ha', target_low: target?.n_low || 100, target_med: target?.n_target || 200, fert: strings.fertilizers.urea },
                { key: 'p', val: p, label: strings.notes.label_phosphorus || 'Phosphorus', unit: 'kg/ha', target_low: target?.p_low || 20, target_med: target?.p_target || 40, fert: strings.fertilizers.dap },
                { key: 'k', val: k, label: strings.notes.label_potassium || 'Potassium', unit: 'kg/ha', target_low: target?.k_low || 100, target_med: target?.k_target || 250, fert: strings.fertilizers.mop }
            ];
            
            npkCheck.forEach(item => {
                const itemLabel = lang === 'ml' ? npkLabelsML[item.key] : item.label;

                if(item.val === '' || item.val === null){ notes.push({ key: 'npk_missing', label: itemLabel }); return; } 
                
                const vv = parseFloat(item.val);
                if(isNaN(vv)) { notes.push({ key: 'npk_invalid', label: itemLabel }); status=strings.status.problem; return; }
                
                if(vv < item.target_low){ 
                    notes.push({ key: 'npk_low', label: itemLabel, v: vv, low: item.target_low }); 
                    rec.push({ key: 'fert_low', fert: item.fert }); 
                    status=strings.status.problem; 
                }
                else if(vv < item.target_med){ 
                    notes.push({ key: 'npk_medium', label: itemLabel, v: vv }); 
                    rec.push({ key: 'fert_medium', crop: plannedCrop }); 
                }
                else { notes.push({ key: 'npk_adequate', label: itemLabel }); }
            });

            
            if(moisture !== '' && moisture !== null){
                const mv = parseFloat(moisture);
                if(isNaN(mv)) { notes.push({ key: 'moisture_invalid' }); status=strings.status.problem; }
                else {
                    if(mv < 12) { notes.push({ key: 'moisture_critical' }); rec.push({ key: 'irrigate_now' }); status=strings.status.problem; }
                    else if(mv < 18){ notes.push({ key: 'moisture_low' }); rec.push({ key: 'irrigate_mulch' }); }
                    else if(mv > 30){ notes.push({ key: 'moisture_high' }); }
                    else { notes.push({ key: 'moisture_ok' }); }
                }
            }

            if(oc !== '' && oc !== null){
                const ocv = parseFloat(oc);
                if(isNaN(ocv)) { notes.push({ key: 'oc_invalid' }); status=strings.status.problem; }
                else {
                    if(ocv < 0.5){ notes.push({ key: 'oc_critical' }); rec.push({ key: 'oc_fym' }); status=strings.status.problem; }
                    else if(ocv < 0.7){ notes.push({ key: 'oc_low' }); rec.push({ key: 'oc_regular' }); }
                    else { notes.push({ key: 'oc_ok' }); }
                }
            }

            let crops = [];
            if(!plannedCrop){
                if(ph !== '' && ph !== null){
                    const phv = parseFloat(ph);
                    if(!isNaN(phv)){
                        if(phv >= 6 && phv <= 7.5){ crops.push('Wheat, Sugarcane, Vegetables'); }
                        if(phv < 6){ crops.push('Rice, Tea (acidic tolerant)'); }
                        if(phv > 7.5){ crops.push('Barley, Mustard, Chickpea'); }
                    }
                }
                if(soilType){
                    if(soilType.toLowerCase().includes('sandy')) crops.push('Groundnut, Pearl millet (Bajra)');
                    if(soilType.toLowerCase().includes('clay')) crops.push('Rice, Sugarcane, Cotton');
                    if(soilType.toLowerCase().includes('loamy')) crops.push('Wheat, Vegetables, Maize');
                }
            } else {
                crops.push(plannedCrop); 
            }

            crops = Array.from(new Set(crops)).slice(0,5);

            function calcFertilizer(n, p, k, target){
                const perAcre = {};

                const N_VAL = parseFloat(n) || 0;
                const P_VAL = parseFloat(p) || 0;
                const K_VAL = parseFloat(k) || 0;

                const N_TARGET_HA = target?.n_target || 150;
                const P_TARGET_HA = target?.p_target || 35;
                const K_TARGET_HA = target?.k_target || 180;
                
                const N_LOW_HA = target?.n_low || 100;
                const P_LOW_HA = target?.p_low || 20;
                const K_LOW_HA = target?.k_low || 100;
                
                if(N_VAL < N_LOW_HA){
                    const N_DEFICIENCY_HA = N_TARGET_HA - N_VAL;
                    
                    perAcre.urea = Math.round((N_DEFICIENCY_HA * 0.4) / 0.46 / 2.5); 
                }
                if(P_VAL < P_LOW_HA){
                    const P_DEFICIENCY_HA = P_TARGET_HA - P_VAL;
                    perAcre.dap = Math.round(P_DEFICIENCY_HA / 0.20 / 2.5); 
                }
                if(K_VAL < K_LOW_HA){
                    const K_DEFICIENCY_HA = K_TARGET_HA - K_VAL;
                    perAcre.mop = Math.round((K_DEFICIENCY_HA * 0.5) / 0.60 / 2.5); 
                }
                return perAcre;
            }

            const fert = calcFertilizer(n,p,k, target);

            return {status, notes, rec, crops, fert, farmerName, plannedCrop, timestamp: new Date().toISOString(), lang};
        }
        function updateBar(idFill, idVal, value, targetMin, targetMax, overallMax, unit=""){
            const fill = document.getElementById(idFill);
            const display = document.getElementById(idVal);

            const v = parseFloat(value);
            const isInvalid = isNaN(v) || value === '';

            if(isInvalid){
                fill.style.width = '0%';
                fill.style.background = '#94a3b8'; // Grey
                fill.textContent = '‚Äî';
                display.textContent = '‚Äî';
                return;
            }

            let pct = 0;
            let color = '#f59e0b'; // Amber (Medium)

            if(idFill === 'bar_ph'){
                const center = 7.0;
                const maxDeviation = 3.5; 
                const deviation = Math.abs(v - center);
                pct = Math.max(0, Math.min(100, 100 - (deviation / maxDeviation) * 100)); 

                if (v < targetMin || v > targetMax) {
                    color = '#ef4444'; 
                } else {
                    color = '#16a34a'; 
                }

            } else {

                const effectiveMax = overallMax || targetMax * 1.5 || 100; 

                pct = Math.round((v / effectiveMax) * 100);
                pct = Math.max(0, Math.min(100, pct));
                
                if (v < targetMin) {
                    color = '#ef4444'; 
                } else if (v >= targetMin && v <= targetMax * 1.1) {
                    color = '#16a34a'; 
                } else if (v > targetMax * 1.1) {
                    color = '#f59e0b'; 
                }
            }
            
            const barWidth = Math.min(100, Math.max(0, pct)) + '%';

            fill.style.width = barWidth;
            fill.style.background = color;
            
            const vFormatted = Number.isInteger(v) ? v : (Math.round(v*100)/100);
            const show = unit ? (vFormatted + unit) : vFormatted;
            
            fill.textContent = show;
            display.textContent = show;
        }

        function updateAllBars(values){
            const target = values.plannedCrop ? cropTargets[values.plannedCrop] : null;

            updateBar('bar_ph','val_ph', values.ph, target?.ph[0] || 6.0, target?.ph[1] || 7.5, 14, ''); 
            updateBar('bar_n','val_n', values.n, target?.n_low || 110, target?.n_target || 150, 300, ' kg/ha');
 
            updateBar('bar_p','val_p', values.p, target?.p_low || 25, target?.p_target || 35, 70, ' kg/ha');
            
            updateBar('bar_k','val_k', values.k, target?.k_low || 120, target?.k_target || 180, 360, ' kg/ha');
            
            updateBar('bar_moisture','val_moisture', values.moisture, 18, 30, 40, '%');
            
            updateBar('bar_oc','val_oc', values.oc, 0.7, 1.5, 3, '%');
        }
        
        function renderAnalysis(result, values){
            output.classList.remove('show');
            setTimeout(()=> output.classList.add('show'), 10);
            lastAnalysisResult = { values, res: result }; 

            const lang = result.lang; 
            const strings = languageAnalysisStrings[lang];
            const notesStrings = strings.notes;
            const recStrings = strings.recommendations;
            const fertStrings = strings.fertilizers;

            if(result.status === strings.status.normal){
                overallTag.textContent = strings.status.normal;
                overallTag.className = 'inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold';
            } else {
                overallTag.textContent = `${strings.status.problem} (${result.status})`;
                overallTag.className = 'inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold';
            }

            cropTitleEl.textContent = values.plannedCrop || 'General Crop Suitability';

            analysisText.innerHTML = '';
            analysisText.innerHTML += '<b>Field:</b> ' + (values.farmerName || '‚Äî') + ' ‚Ä¢ <b>Target Crop:</b> ' + (values.plannedCrop || 'None') + '<br>';
            analysisText.innerHTML += '<b>pH:</b> ' + (values.ph ?? '‚Äî') + ' ‚Ä¢ <b>N:</b> '+(values.n ?? '‚Äî')+' ‚Ä¢ <b>P:</b> '+(values.p ?? '‚Äî')+' ‚Ä¢ <b>K:</b> '+(values.k ?? '‚Äî') +'<br>';
            analysisText.innerHTML += '<b>Moisture:</b> ' + (values.moisture ?? '‚Äî') + '% ‚Ä¢ <b>OC:</b> ' + (values.oc ?? '‚Äî') + '% ‚Ä¢ <b>Soil Type:</b> ' + (values.soilType || '‚Äî') + '<br>';
            analysisText.innerHTML += '<hr class="my-2 border-green-100">';

            analysisText.innerHTML += '<b>Observations:</b><ul class="list-disc list-inside space-y-0.5 mt-1">';
            result.notes.forEach(note => {
                let noteText = notesStrings[note.key];
                if(typeof noteText === 'function') noteText = noteText(note.v, note.target, note.crop, note.label, note.low);
                analysisText.innerHTML += '<li>' + noteText + '</li>'; 
            });
            analysisText.innerHTML += '</ul>';

            recommendations.innerHTML = '';
            if(result.crops.length && !values.plannedCrop) recommendations.innerHTML += `<p class="mb-1"><b>${recStrings.suggested_crops}</b> ${result.crops.join(', ')}</p>`;
            if(result.rec.length){
                recommendations.innerHTML += `<b>${recStrings.immediate_actions}</b><ul class="list-disc list-inside space-y-0.5 mt-1">`;
                result.rec.forEach(recItem => {
                    let recText = recStrings[recItem.key];
                    if(typeof recText === 'function') recText = recText(recItem.fert, recItem.crop);
                    recommendations.innerHTML += '<li>' + recText + '</li>'; 
                });
                recommendations.innerHTML += '</ul>';
            } else {
                recommendations.innerHTML = recStrings.no_actions;
            }

            fertCalc.innerHTML = '';
            if(Object.keys(result.fert).length === 0) {
                fertCalc.innerHTML = 'No major fertilizer additions required based on low/medium thresholds.';
            } else {
                fertCalc.innerHTML += `<p>${recStrings.fertilizer_est}</p>`;
                fertCalc.innerHTML += '<ul class="list-disc list-inside space-y-0.5 mt-1">';
                if(result.fert.urea) fertCalc.innerHTML += `<li>${fertStrings.urea}: <b>${result.fert.urea} kg/acre</b> (approx)</li>`;
                if(result.fert.dap) fertCalc.innerHTML += `<li>${fertStrings.dap}: <b>${result.fert.dap} kg/acre</b> (approx)</li>`;
                if(result.fert.mop) fertCalc.innerHTML += `<li>${fertStrings.mop}: <b>${result.fert.mop} kg/acre</b> (approx)</li>`;
                fertCalc.innerHTML += '</ul>';

                const needed = Object.keys(result.fert).map(f => f.toLowerCase());
                showFertilizerPrices(needed);
            }

            const rainForecast = (values.rainfall || '').split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            const forecast = predictMoisture(values.moisture, values.soilType, rainForecast, 7);
            const forecastStrings = strings.forecast;
            
            moistureForecastContentEl.innerHTML = '';
            if(forecast.status === 'Missing Data'){
                moistureForecastContentEl.innerHTML = forecastStrings.missing;
            } else {
                moistureForecastContentEl.innerHTML += '<table class="w-full text-left table-auto">';
                moistureForecastContentEl.innerHTML += `<thead><tr class="border-b border-cyan-200"><th class="py-1 px-1">${forecastStrings.table_day}</th><th class="py-1 px-1">${forecastStrings.table_rain}</th><th class="py-1 px-1">${forecastStrings.table_moisture}</th><th class="py-1 px-1">${forecastStrings.table_action}</th></tr></thead><tbody>`;
                forecast.results.forEach(r => {
                    const color = r.action.includes(forecastStrings.action_now) ? 'text-red-600 font-bold' : (r.action.includes(forecastStrings.action_monitor) ? 'text-orange-600' : 'text-green-600');
                    moistureForecastContentEl.innerHTML += `<tr><td class="py-1 px-1">${forecastStrings.table_day} ${r.day}</td><td class="py-1 px-1">${r.rain}</td><td class="py-1 px-1">${r.moisture}%</td><td class="py-1 px-1 ${color}">${r.action}</td></tr>`;
                });
                moistureForecastContentEl.innerHTML += '</tbody></table>';
                moistureForecastContentEl.innerHTML += `<p class="mt-2 text-sm text-gray-600">${forecastStrings.note}</p>`;
            }

            
            historyTrendsEl.innerHTML = 'Click "View Trends" to load history from the cloud.';

            dateTime.textContent = new Date(result.timestamp).toLocaleString();
            updateAllBars(values);
        }

        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject("Geolocation not supported.");
                }
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
                    err => reject("Location permission denied.")
                );
            });
        }
        async function getNearbyFertilizerShops(lat, lon, requiredFerts = []) {
            
            const overpassUrl = "https://overpass-api.de/api/interpreter";
            const searchRadius = 10000;
            const query = `
                [out:json][timeout:25];
                (
                    node["shop"="agricultural_supplies"](around:${searchRadius}, ${lat}, ${lon});
                    node["shop"="farm"](around:${searchRadius}, ${lat}, ${lon});
                    node["amenity"="marketplace"](around:${searchRadius}, ${lat}, ${lon});
                );
                out center;
            `;
            try {
                const response = await fetch(overpassUrl, {
                    method: "POST",
                    headers: { 'Content-Type': 'text/plain' },
                    body: query
                });
                if(!response.ok) throw new Error('Overpass request failed');
                const data = await response.json();
                const baseRates = { urea: 270, dap: 1250, mop: 850 };
                const shops = (data.elements || []).map(shop => {
                    const latS = shop.lat || shop.center?.lat;
                    const lonS = shop.lon || shop.center?.lon;
                    const distanceMeters = latS ? Math.round(Math.sqrt(Math.pow(lat - latS, 2) + Math.pow(lon - lonS, 2)) * 111000) : null;
                    const prices = {};
                    requiredFerts.forEach(f => {
                        const key = f.toLowerCase();
                        prices[key] = baseRates[key] || null;
                    });
                    return {
                        name: shop.tags?.name || (shop.tags?.operator || "Fertilizer Dealer"),
                        lat: latS,
                        lon: lonS,
                        distance: distanceMeters,
                        prices
                    };
                });
                shops.sort((a,b) => (a.distance||999999) - (b.distance||999999));
                return shops.slice(0, 8);
            } catch (e) {
                console.warn('Overpass error', e);
                return [];
            }
        }
        async function showFertilizerPrices(requiredFerts) {
            const container = document.getElementById("fertCalc");
            const shopsAreaId = 'fert-shops-area';
            const existing = document.getElementById(shopsAreaId);
            if(existing) existing.remove();

            const shopsWrapper = document.createElement('div');
            shopsWrapper.id = shopsAreaId;
            shopsWrapper.className = 'mt-4';

            shopsWrapper.innerHTML = `<h4 class="font-semibold text-green-800 mb-1">Nearby Fertilizer Prices</h4>
                <div class="text-sm text-gray-600 mb-2">(Allow location permission to see nearest dealers and approximate rates.)</div>
                <div id="shopsList">Searching for nearby dealers‚Ä¶</div>`;

            container.appendChild(shopsWrapper);

            try {
                const loc = await getUserLocation();
                const shops = await getNearbyFertilizerShops(loc.lat, loc.lon, requiredFerts);

                const listEl = document.getElementById('shopsList');
                listEl.innerHTML = '';
                if (!shops || shops.length === 0) {
                    listEl.innerHTML = '<div class="text-sm text-gray-600">No fertilizer dealers found within 10 km or the mapping service failed to respond.</div>';
                    return;
                }

                shops.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'p-3 bg-white border rounded-lg shadow-sm mb-2';
                    const name = `<div class="font-semibold text-green-700">${s.name}</div>`;
                    const dist = `<div class="text-sm text-gray-600">Distance: ${s.distance ? (s.distance/1000).toFixed(1) + ' km' : '‚Äî'}</div>`;
                    const priceList = `<ul class="text-sm mt-1">${Object.keys(s.prices).map(f => {
                        const p = s.prices[f];
                        return `<li>${f.toUpperCase()}: ${p ? '‚Çπ' + p + '/bag' : 'Price N/A'}</li>`;
                    }).join('')}</ul>`;

                    card.innerHTML = name + dist + priceList;
                    listEl.appendChild(card);
                });

            } catch (e) {
                const listEl = document.getElementById('shopsList');
                listEl.innerHTML = `<div class="text-red-600 text-sm">Location needed to fetch dealers ‚Äî ${e}</div>`;
            }
        }
        
        function runAnalysisAndSave() {
            hideMessage();
            const values = {
                ph: phEl.value, n: nEl.value, p: pEl.value, k: kEl.value,
                moisture: mEl.value, oc: ocEl.value, soilType: soilTypeEl.value, 
                farmerName: farmerNameEl.value, plannedCrop: plannedCropEl.value,
                rainfall: rainfallEl.value
            };

            if (values.ph === '' && values.n === '' && values.p === '' && values.k === '') {
                showMessage('‚ö†Ô∏è Please **Parse** a soil report file first to get the soil test values (N, P, K, pH) before running the analysis.', true);
                return;
            }

            try {
                const res = analyze(values);
                renderAnalysis(res, values); 
                saveToCloud(values, res); 
            } catch (error) {
                console.error("Analysis or Rendering Error:", error);
                showMessage("‚ùå An unexpected internal error occurred during analysis. Check the browser console for details.", true);
            }
        }
        
        document.getElementById('analyzeBtn').addEventListener('click', runAnalysisAndSave);

        
        document.getElementById('historyBtn').addEventListener('click', ()=>{
            const fieldId = farmerNameEl.value;
            if(!fieldId || fieldId === 'Farmer-ID-from-File'){ 
                showMessage('Please run an analysis first (by parsing a file) to ensure all data is loaded and a field ID is available.', true); 
                return; 
            }
            
            output.classList.remove('show');
            setTimeout(()=> output.classList.add('show'), 10);
            
            
            loadHistory(fieldId); 
        });

        
        document.getElementById('pdfBtn').addEventListener('click', async ()=>{
            let snapshot = {};
            if(lastAnalysisResult) snapshot = lastAnalysisResult;
            
            const docInfo = {
                title: 'Soil Health Report - Krishi Mitra',
                generatedAt: new Date().toLocaleString(),
                content: snapshot
            };
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit:'pt', format:'a4'});
            doc.setFontSize(16);
            doc.text(docInfo.title, 40, 60);
            doc.setFontSize(10);
            doc.text('Generated: ' + docInfo.generatedAt, 40, 80);

            const values = (snapshot.values || snapshot.res?.values) || {
                ph: phEl.value, n: nEl.value, p: pEl.value, k: kEl.value,
                moisture: mEl.value, oc: ocEl.value, soilType: soilTypeEl.value, 
                farmerName: farmerNameEl.value, plannedCrop: plannedCropEl.value, rainfall: rainfallEl.value
            };

            let y = 110;
            doc.setFontSize(12);
            doc.text('Field: ' + (values.farmerName || '‚Äî') + ' | Target Crop: ' + (values.plannedCrop || '‚Äî'), 40, y); y+=18;
            doc.text('pH: ' + (values.ph || '‚Äî') + '    N: ' + (values.n || '‚Äî') + '    P: ' + (values.p || '‚Äî') + '    K: ' + (values.k || '‚Äî'), 40, y); y+=18;
            doc.text('Moisture: ' + (values.moisture || '‚Äî') + '%    OC: ' + (values.oc || '‚Äî') + '%    Soil Type: ' + (values.soilType || '‚Äî'), 40, y); y+=22;
            doc.text('Rainfall Forecast: ' + (values.rainfall || '‚Äî'), 40, y); y+=22;

            if(snapshot.res){
                doc.setFontSize(11);
                doc.text('Observations:', 40, y); y+=14;
                snapshot.res.notes.forEach(note=>{
                    let line = note.key; 
                    if(snapshot.res.lang === 'ml') line = languageAnalysisStrings['ml'].notes[line];
                    if(typeof line === 'function') line = line(note.v, note.target, note.crop, note.label, note.low);
                    doc.text('- ' + line, 52, y); y+=14;
                });
                y+=6;
                if(snapshot.res.rec && snapshot.res.rec.length){
                    doc.text('Actions:', 40, y); y+=14;
                    snapshot.res.rec.forEach(recItem => { 
                        let line = recItem.key;
                        if(snapshot.res.lang === 'ml') line = languageAnalysisStrings['ml'].recommendations[line];
                        if(typeof line === 'function') line = line(recItem.fert, recItem.crop);
                        doc.text('- ' + line, 52, y); y+=14; 
                    });
                }
            } else {
                doc.text('No analysis snapshot found. Please run Analyze and Save before exporting for best result.', 40, y);
            }

            doc.save('soil-report-krishi-mitra.pdf');
        });

        
        document.getElementById('parseBtn').addEventListener('click', async ()=>{
            const fileInput = document.getElementById('fileUpload');
            if(!fileInput.files || fileInput.files.length === 0){ showMessage('Choose a file first (PDF/TXT).', true); return; }
            const file = fileInput.files[0];
            const name = file.name.toLowerCase();
            let parsedSuccessfully = false;

            if(/\.txt$/.test(name) || /\.csv$/.test(name) || /\.json$/.test(name)){
                const txt = await file.text();
                parsedSuccessfully = applyExtracted(txt); 
            } else if(/\.pdf$/.test(name)){
                showMessage('PDF parsing in-browser is limited. If your PDF is text-based, paste the text into a text file and try the upload. Alternatively, please provide a plain text or CSV file from the lab.', true);
            } else {
                showMessage('File type not supported for auto-parse. Try TXT, CSV, or a clean text PDF. Please ensure the soil report is a text-based file.', true);
            }

            if (parsedSuccessfully) {
                runAnalysisAndSave(); 
            }
        });

        function applyExtracted(text){
            const patterns = {
                ph: /pH.*?([0-9]{1,2}\.?[0-9]{1,2})/i,
                n: /nitro(?:gen)?.*?([0-9]{1,4})/i,
                p: /phosphor(?:us)?.*?([0-9]{1,4})/i,
                k: /potassi(?:um)?.*?([0-9]{1,4})/i,
                oc: /organic\s+carbon.*?([0-9]+\.?[0-9]*)/i,
                moisture: /moisture.*?([0-9]{1,3}\.?[0-9]*)/i,
                rainfall: /rain(?:fall| forecast)?.*?([0-9]+(?:,[0-9]+)*)/i, 
                farmerName: /(farmer|field|sample)\s*(?:id|name|no)\s*[:\s]*([a-z0-9\s\-]+)/i 
            };
            let foundAny=false;
            for(const key in patterns){
                const m = text.match(patterns[key]);
                if(m){
                    foundAny=true;
                    const val = key === 'farmerName' ? m[2].trim() : m[1].trim(); 

                    if(key==='ph') phEl.value = val;
                    if(key==='n') nEl.value = val;
                    if(key==='p') pEl.value = val;
                    if(key==='k') kEl.value = val;
                    if(key==='oc') ocEl.value = val;
                    if(key==='moisture') mEl.value = val;
                    if(key==='rainfall') rainfallEl.value = val;
                    if(key==='farmerName') farmerNameEl.value = val; 
                }
            }
            const soilm = text.match(/(sandy|loamy|clay|black|red)\s+soil/i);
            if(soilm){ soilTypeEl.value = soilm[1]; foundAny=true; }
            
            if(foundAny) showMessage('Parsed values applied to the form. Now automatically running analysis.');
            else showMessage('No recognisable values found in the file (pH, N, P, K, Moisture missing). Please try a plain-text report.', true);
            
            return foundAny; 
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeOutput(); 
        });

        
    </script>
</body>
</html>
